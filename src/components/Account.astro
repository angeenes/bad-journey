---
---

<article
  class="bg-primary flex flex-col justify-center items-center text-white w-full mt-11 p-4"
>
  <section id="account"></section>

  <section class="flex mt-3 gap-x-5">
    <button id="btnDisconnect">Disconnect</button>
    <button id="btnDelete">Delete account</button>
  </section>
</article>

<script>
  import { API_URL, IMAGES_URL } from "src/consts";
  import { Avatar, User } from "../assets/types/userObject";

  class Account {
    private user: User;
    public accountEl: HTMLElement;
    public btnDisconnect: HTMLButtonElement;

    constructor() {
      this.user = {
        id: 0,
        username: "",
        email: "",
        provider: "",
        confirmed: false,
        blocked: true,
        createdAt: "",
        updatedAt: "",
        avatar: {} as Avatar,
      };
      this.accountEl = document.getElementById("account") as HTMLElement;
      this.btnDisconnect = document.getElementById(
        "btnDisconnect"
      ) as HTMLButtonElement;
    }
    public async init(): Promise<void> {
      this.user = await this.getUser();
      if (this.user.confirmed) {
        this.saveUser(this.user);
        this.displayAccount();
        this.disconnect();
      }
      console.log(this.user);
    }

    public disconnect() {
      this.btnDisconnect.addEventListener("click", () => {
        localStorage.removeItem("user");
        localStorage.removeItem("jwt");
        window.location.href = "/";
      });
    }

    private saveUser(user: User) {
      localStorage.setItem("user", JSON.stringify(user));
    }

    private displayAccount() {
      const user = this.user;
      const html = `
        <div class="">
          <h2 class="mb-4 text-bold uppercase">Account</h2>
          <img src="${IMAGES_URL}${user.avatar?.formats.thumbnail.url}" alt="${user.username}" class="rounded-full"/>
          <p>Username: ${user.username}</p>
          <p>Email: ${user.email}</p>
          <p>Provider: ${user.provider}</p>
          <p>Confirmed: ${user.confirmed}</p>
          <p>Blocked: ${user.blocked}</p>
          <p>Created at: ${user.createdAt}</p>
          <p>Updated at: ${user.updatedAt}</p>
      `;
      this.accountEl.innerHTML = html;
    }

    private getUser(): User | PromiseLike<User> {
      const userLocalStorage = localStorage.getItem("user");
      const jwtLocalStorage = localStorage.getItem("jwt");
      if (!userLocalStorage && !jwtLocalStorage) {
        throw new Error("No user in local storage");
      } else {
        // return JSON.parse(userLocalStorage);
        console.log(jwtLocalStorage);
        const headers = {
          "Content-Type": "application/json",
          Authorization: `Bearer ${jwtLocalStorage}`,
        };
        return fetch(
          `${API_URL}/users/me?populate[avatar][fields][0]=formats`,
          {
            headers,
          }
        )
          .then((response) => response.json())
          .then((data) => data);
      }
    }
  }

  const account = new Account();
  account.init();
</script>

<script>
  import { Gallery } from "@classes/gallery";
  import { User } from "@classes/user";

  export const user = new User();
  const userId = user.getUserId();

  export const loader = new Gallery(undefined, userId);
  loader.init();
</script>
