---
---

<section class="container-full">
  <article  id="gallery" class="gallery container"></article>
   <div id="load-more" class="text-center">Loading...</div>
</section>

<script>
class Gallery {
  constructor() {
    this.currentPage = 1;
    this.itemsPerPage = 10;
    this.loading = false;
    this.apiToken = '4fb7c32206dda5da38a373ecd922aa9a21a0c2916728ef207f7c424f50eeeeee47beedd0354809612fbd27fcce2693b0d4344d319fe0fd0044b14c1001e5ad105be5d47c844c44b8ede116366d6e48c49fbd6333a74ef6136787ca2e21db61c3b35359bcb60d58d14cbbc1457e58e089b581ca3df505c5f9f102906892679d2f';
    this.url = 'https://hammerhead-app-377qb.ondigitalocean.app'
    this.init();
  }

  // async fetchData(page) {
  //   const response = await fetch(
  //     `https://jsonplaceholder.typicode.com/posts?_page=${page}&_limit=${this.itemsPerPage}`
  //   );
  //   const data = await response.json();
  //   return data;
  // }

  async fetchData(page) {
  const response = await fetch(
    this.url + `/api/images?populate=*&pagination[page]=${this.currentPage}&pagination[pageSize]=${this.itemsPerPage}`,
    {
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + this.apiToken 
      }
    }
  );
  const data = await response.json();
  return data;
}


  createCardTemplate(item) {
    return `
          <div class="card">
              <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="${this.url + item.attributes.image.data.attributes.formats.thumbnail.url}" alt="Image for post ${item.attributes.file_name}" loading="lazy">
              <h2>${item.attributes.file_name}</h2>
              <p>${item.attributes.parameters}</p>
          </div>
      `;
  }

  renderCards(data) {
    const cardContainer = document.getElementById('gallery');
    data.data.forEach((item) => {
      const cardTemplate = this.createCardTemplate(item);
      cardContainer.insertAdjacentHTML('beforeend', cardTemplate);
    });
  }

  observeImages() {
    const images = document.querySelectorAll('img:not([data-loaded="true"])');
    const imageObserver = new IntersectionObserver((entries, observer) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const image = entry.target;
          image.src = image.dataset.src;
          image.onload = () => {
            image.dataset.loaded = 'true';
          };
          observer.unobserve(image);
        }
      });
    });

    images.forEach((image) => imageObserver.observe(image));
  }

setupInfiniteScroll() {
    const loadMoreElement = document.getElementById('load-more');
    const loadMoreObserver = new IntersectionObserver((entries, observer) => {
      entries.forEach(async (entry) => {
        if (entry.isIntersecting && !this.loading) {
          this.loading = true;
          observer.unobserve(loadMoreElement);
          this.currentPage++;
          const newData = await this.fetchData(this.currentPage);
          this.renderCards(newData);
          this.observeImages();

          // Check if the last page is reached
          if (newData.length === this.itemsPerPage) {
            observer.observe(loadMoreElement);
          } else {
            // If you want to show a message when there is no more data to load, you can do it here
            const endOfResultsMessage = document.createElement('p');
            endOfResultsMessage.textContent = 'You have reached the end of the results.';
            loadMoreElement.parentNode.insertBefore(endOfResultsMessage, loadMoreElement);
            loadMoreElement.style.display = 'none';
          }
          this.loading = false;
        }
      });
    });

    loadMoreObserver.observe(loadMoreElement);
  }

  async init() {
    const initialData = await this.fetchData(this.currentPage);
    this.renderCards(initialData);
    this.observeImages();
    this.setupInfiniteScroll();
  }
}

const gallery = new Gallery();


</script>

<style lang='scss'>
.gallery {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  flex-wrap: wrap;
  gap: 1.5rem;
  .card {
    box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
    transition: 0.3s;
    width: 300px;
    border-radius: 5px;
    padding: 20px;
    margin-bottom: 20px;
  }
  .card:hover {
    box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2);
    cursor: pointer;
  }
  .card img {
    width: 100%;
    height: auto;
    border-radius: 5px;
    margin-bottom: 15px;
    opacity: 0;
    transition: opacity 0.3s;
  }
  .card img[data-loaded="true"] {
    opacity: 1;
  }
}
</style>
