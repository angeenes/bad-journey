---
---

<section class="container-full">
  <article  id="gallery" class="gallery container"></article>
   <div id="load-more" class="text-center">Loading...</div>
</section>

<script>
class Gallery {
  constructor() {
    this.currentPage = 1;
    this.itemsPerPage = 10;
    this.loading = false;
    this.apiToken = 'eaaee52512d5885e2f301c3d39b314eda624605e6c94e190c5a21a28dd4a5065f5a652940320ae8a19c2ad4499bcf54d86c931f83dbff7c57c26fd0c3b920bf7b5dfaa9eea973c8863b2070d33e46582ed88c6266aa57243583a95564ae3465009362aec750c1aa6df841e4e3edb9db6c337474d4f5bb44514728f2db06485bf';
    this.url = 'http://localhost:1337'
    this.init();
  }

  // async fetchData(page) {
  //   const response = await fetch(
  //     `https://jsonplaceholder.typicode.com/posts?_page=${page}&_limit=${this.itemsPerPage}`
  //   );
  //   const data = await response.json();
  //   return data;
  // }

  async fetchData(page) {
  const response = await fetch(
    this.url + `/api/images?populate=*&pagination[page]=${this.currentPage}&pagination[pageSize]=${this.itemsPerPage}`,
    {
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + this.apiToken 
      }
    }
  );
  const data = await response.json();
  return data;
}


  createCardTemplate(item) {
    return `
          <div class="card">
              <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="${this.url + item.attributes.image.data.attributes.formats.thumbnail.url}" alt="Image for post ${item.attributes.file_name}" loading="lazy">
              <h2>${item.attributes.file_name}</h2>
              <p>${item.attributes.parameters}</p>
          </div>
      `;
  }

  renderCards(data) {
    const cardContainer = document.getElementById('gallery');
    data.data.forEach((item) => {
      const cardTemplate = this.createCardTemplate(item);
      cardContainer.insertAdjacentHTML('beforeend', cardTemplate);
    });
  }

  observeImages() {
    const images = document.querySelectorAll('img:not([data-loaded="true"])');
    const imageObserver = new IntersectionObserver((entries, observer) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const image = entry.target;
          image.src = image.dataset.src;
          image.onload = () => {
            image.dataset.loaded = 'true';
          };
          observer.unobserve(image);
        }
      });
    });

    images.forEach((image) => imageObserver.observe(image));
  }

setupInfiniteScroll() {
    const loadMoreElement = document.getElementById('load-more');
    const loadMoreObserver = new IntersectionObserver((entries, observer) => {
      entries.forEach(async (entry) => {
        if (entry.isIntersecting && !this.loading) {
          this.loading = true;
          observer.unobserve(loadMoreElement);
          this.currentPage++;
          const newData = await this.fetchData(this.currentPage);
          this.renderCards(newData);
          this.observeImages();

          // Check if the last page is reached
          if (newData.length === this.itemsPerPage) {
            observer.observe(loadMoreElement);
          } else {
            // If you want to show a message when there is no more data to load, you can do it here
            const endOfResultsMessage = document.createElement('p');
            endOfResultsMessage.textContent = 'You have reached the end of the results.';
            loadMoreElement.parentNode.insertBefore(endOfResultsMessage, loadMoreElement);
            loadMoreElement.style.display = 'none';
          }
          this.loading = false;
        }
      });
    });

    loadMoreObserver.observe(loadMoreElement);
  }

  async init() {
    const initialData = await this.fetchData(this.currentPage);
    this.renderCards(initialData);
    this.observeImages();
    this.setupInfiniteScroll();
  }
}

const gallery = new Gallery();


</script>

<style lang='scss'>
.gallery {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  flex-wrap: wrap;
  gap: 1.5rem;
  .card {
    box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
    transition: 0.3s;
    width: 300px;
    border-radius: 5px;
    padding: 20px;
    margin-bottom: 20px;
  }
  .card:hover {
    box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2);
    cursor: pointer;
  }
  .card img {
    width: 100%;
    height: auto;
    border-radius: 5px;
    margin-bottom: 15px;
    opacity: 0;
    transition: opacity 0.3s;
  }
  .card img[data-loaded="true"] {
    opacity: 1;
  }
}
</style>
