---
import BaseHead from "../../../components/BaseHead.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from '../../../consts';
---

<!DOCTYPE html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
	</head>
	<body>
        Welcome to {SITE_TITLE}
        <br>
        You have been successfully logged in with your GOOGLE account.
        <br>
        You will be redirected in a few seconds...
	</body>
</html>


<style>
    body {
        background-color: var(--color-primary);
        text-align: center;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
    }
</style>


<script>
    import { OauthObject } from "../../../assets/types/OauthObject.js";
    import { API_URL } from "../../../consts.js";

class Login {

  getUrlParameters(): OauthObject {
    var params = {};
    window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi, (substring: string, key: string, value: string) => {
        params[key] = value;
        return ''; // renvoie une chaÃ®ne vide pour remplacer la correspondance
    });

    return params as OauthObject;
  }

  retrieveUserInfos() {
    const bodyEl = document.querySelector("body");
    const params: OauthObject = this.getUrlParameters();
    fetch(`${API_URL}auth/google/callback?access_token=${params.access_token}`)
      .then(res => {
        if (res.status !== 200) {
          res.json().then(res =>{
            // console.log('ERRORR', res);
            const message = res.error.message;
            if (bodyEl) {
              bodyEl.innerHTML = `An error occured while logging : ${message}, <br>  You will be redirected in a few seconds...`;
            }
          })
          throw new Error(`Couldn't login. Status: ${res.status}`);
        }
        return res;
      })
      .then(res => res.json())
      .then(res => {
        console.log(res);
        localStorage.setItem("jwt", res.jwt);
        localStorage.setItem("user", JSON.stringify(res.user));
        setTimeout(() => {
          window.location.href = "/account";
        }, 2500);
      })
      .catch(err => console.log(err));
  }

  init() {
    this.retrieveUserInfos();
  }
}

const redirectLogin = new Login();
redirectLogin.init();

</script>